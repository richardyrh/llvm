#!/bin/bash
# Assumes current dir is build dir
LLVM_PREBUILT="$1"
MUON_LLVM_INSTALL="$2"
SYSROOT=$PWD
CFLAGS="-march=rv32im_zfinx_zhinx --sysroot=$SYSROOT -fPIC"
CXXFLAGS="-march=rv32im_zfinx_zhinx --sysroot=$SYSROOT -fPIC"
TARGET="riscv32-unknown-elf"

cmake -G "Ninja" ../llvm \
-DLLVM_ENABLE_PROJECTS="clang;lld" \
-DLLVM_ENABLE_RUNTIMES="libc;compiler-rt" \
-DLLVM_ABI_BREAKING_CHECKS=FORCE_OFF \
-DLLVM_INCLUDE_EXAMPLES=OFF \
-DLLVM_INCLUDE_TESTS=OFF \
-DBUILD_SHARED_LIBS=ON \
-DLLVM_BUILD_TESTS=OFF \
-DLLVM_OPTIMIZED_TABLEGEN=ON \
-DLLVM_DEFAULT_TARGET_TRIPLE=$TARGET \
-DLLVM_TARGETS_TO_BUILD="RISCV" \
-DCMAKE_BUILD_TYPE=Release \
-DLLVM_ENABLE_ASSERTIONS=ON \
-DCMAKE_INSTALL_PREFIX=$MUON_LLVM_INSTALL \
-DCMAKE_BUILD_WITH_INSTALL_RPATH=ON \
-DCLANG_DEFAULT_RTLIB=compiler-rt \
-DCMAKE_C_COMPILER=$LLVM_PREBUILT/clang \
-DCMAKE_CXX_COMPILER=$LLVM_PREBUILT/clang++ \
-DCMAKE_AR=$LLVM_PREBUILT/llvm-ar \
-DCMAKE_NM=$LLVM_PREBUILT/llvm-nm \
-DCMAKE_RANLIB=$LLVM_PREBUILT/llvm-ranlib \
-DLLVM_LIBC_FULL_BUILD=ON \
-DLLVM_RUNTIME_TARGETS=$TARGET \
-DLLVM_BUILTIN_TARGETS=$TARGET \
-DRUNTIMES_riscv32-unknown-elf_LLVM_LIBC_FULL_BUILD=ON \
-DRUNTIMES_riscv32-unknown-elf_CMAKE_C_FLAGS="$CFLAGS" \
-DRUNTIMES_riscv32-unknown-elf_CMAKE_CXX_FLAGS="$CXXFLAGS" \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BAREMETAL_BUILD=ON \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BUILD_BUILTINS=ON \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BUILD_SANITIZERS=OFF \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BUILD_XRAY=OFF \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BUILD_LIBFUZZER=OFF \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BUILD_PROFILE=OFF \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BUILD_MEMPROF=OFF \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BUILD_ORC=OFF \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_BUILD_GWP_ASAN=OFF \
-DRUNTIMES_riscv32-unknown-elf_COMPILER_RT_USE_BUILTINS_LIBRARY=ON \
-DRUNTIMES_riscv32-unknown-elf_CMAKE_SYSROOT="$SYSROOT" \
-DBUILTINS_riscv32-unknown-elf_COMPILER_RT_BAREMETAL_BUILD=ON \
-DBUILTINS_riscv32-unknown-elf_CMAKE_SYSROOT="$SYSROOT" \
-DBUILTINS_riscv32-unknown-elf_CMAKE_C_FLAGS="$CFLAGS" \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_EXCEPTIONS=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_SHARED=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_THREADS=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_MONOTONIC_CLOCK=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_WIDE_CHARACTERS=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_LOCALIZATION=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_FSTREAM=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_IOSTREAM=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_FILESYSTEM=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXX_ENABLE_RANDOM_DEVICE=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_ENABLE_EXCEPTIONS=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_USE_LLVM_UNWINDER=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_ENABLE_STATIC_UNWINDER=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_ENABLE_SHARED=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_ENABLE_THREADS=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_USE_COMPILER_RT=ON \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_BAREMETAL=ON \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_ENABLE_NEW_DELETE_DEFINITIONS=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_ENABLE_ASSERTIONS=OFF \
-DRUNTIMES_riscv32-unknown-elf_LIBCXXABI_ENABLE_SHARED=OFF \
